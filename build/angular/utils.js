/* eslint-disable no-console */
import __dirname from "../__dirname.js";
import { readdir } from "fs/promises";
import { getJsonFromPath } from "../json.js";
import config from "./config.js";

/**
 * root directory for angular projects to build
 * Contains one subfolder by supported angular version
 */
const angularTemplatesPath = `${ __dirname }/angular/_templates/`;

/**
 * get list of angular project directories
 * return only directories that starts with angular+versionNumber
 * eg : angular12, angular13...
 * @return array
 */
export const getAngularDirectories = async () =>
    ( await readdir( angularTemplatesPath, {
        'withFileTypes': true,
    } ) )
        // only directories
        .filter( dirent => dirent.isDirectory() )
        // only directories named angular + versionNumber
        .filter( dirent => dirent.name.match( /angular[0-9]+$/ ) )
        .map( dirent => {
            const obj = {
                "name": dirent.name,
                "path": `${ angularTemplatesPath }${ dirent.name }`,
                "angularJsonPath": `${ angularTemplatesPath }${ dirent.name }/angular.json`,
                "packageJsonPath": `${ angularTemplatesPath }${ dirent.name }/lib/package.json`,
            };
            return obj;
        } );

/**
* returns dist folder paths
* twicDist : final dist folder related to current angular project
* ngcDist : legacy dist folder (generated by ng build process)
* @param {*} angularDirectory : current angular project informations
*/
export const getDistFolder = angularDirectory => ( {
    "twicDist": `${ __dirname }/../dist/${ angularDirectory.name }`,
    "ngcDist": `${ angularDirectory.path }/dist`,
} );

/**
 * returns exports keys from a generated packageJson
 * @param {*} packageJson
 * @returns
 */
export const getExportsKeys = packageJson => Object.keys( packageJson )
    .filter( key => key.match( /^(module)|(main)|(((fesm)|(es))[0-9]+)|(typings)|(metadata)$/ ) );

/**
 * get list of angular library to build for the given angularDirectory
 * It is possible to have n libraries in an angular project defined by it's angularDirectory
 * @param angularDirectory
 * @returns {Promise<null|*[]>}
 */
export const getProjectsByDirectory = async angularDirectory => {

    const projectsByDirectory = [];
    const angularJson = await getJsonFromPath( angularDirectory.angularJsonPath );

    if ( !angularJson ) {
        return null;
    }
    // for each project defined in angular.json
    Object.keys( angularJson.projects ).forEach( projectName => {
        projectsByDirectory.push( {
            projectName,
            "project": angularJson.projects[ projectName ],
        } );
    } );

    // return only library project
    return projectsByDirectory.filter( angularProject => angularProject.project.projectType === `library` );
};

const _versionAliases = [];

/**
 * returns an array of aliases between the reference and the actual angular version
 * @returns [{reference, version}]
 */
export const getVersionAliases = () => {
    if ( _versionAliases.length === 0 ) {
        const { build, from, noDirectoryImport, to } = config;
        let reference;
        for ( let version = from; version <= to; version++ ) {
            if ( build.includes( version ) ) {
                reference = version;
            }
            _versionAliases.push( {
                "noDirectoryImport": noDirectoryImport.includes( version ),
                reference,
                version,
            } );
        }
    }
    return _versionAliases;
};

const _packageJsonMap = new Map();
/**
 * a map that contains the generated reference package.json
 */
export const getPackageJsonMap = async () => {
    if ( _packageJsonMap.size === 0 ) {
        await Promise.all(
            getVersionAliases().map( async alias => {
                const { reference } = alias;
                if ( !_packageJsonMap.get( reference ) ) {
                    _packageJsonMap.set(
                        reference,
                        await getJsonFromPath( `${ __dirname }/../dist/angular${ reference }/package.json` )
                    );
                }
            } )
        );
    }
    return _packageJsonMap;
};
